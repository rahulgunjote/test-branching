name: Release Build

on:
  push:
    branches: [ releases/* ]
  workflow_dispatch:
    inputs:
      release_branch:
        description: 'Release branch to build from (e.g., releases/v1.0.0)'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

env:
  GITHUB_PULL_REQUEST_API_TOKEN: ${{ secrets.PULL_REQUEST_API_TOKEN }}
  X_SCHEME: ${{ vars.X_SCHEME }}
  X_PROJ_DIR: ${{ vars.X_PROJ_DIR }}
  X_WORKSPACE_DIR: ${{ vars.X_WORKSPACE_DIR }}
  RELEASE_BRANCH: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.release_branch || github.ref }}

jobs:
  # test:
  #   name: Test
  #   runs-on: macos-latest
    
  #   steps:
  #   - name: Checkout
  #     uses: actions/checkout@v4
      
  #   - name: Setup Ruby
  #     uses: ruby/setup-ruby@v1
  #     with:
  #       ruby-version: '3.2'
  #       bundler-cache: true
        
  #   - name: Setup Xcode
  #     uses: maxim-lobanov/setup-xcode@v1
  #     with:
  #       xcode-version: latest-stable
        
  #   - name: Install dependencies
  #     run: |
  #       bundle install
        
  #   - name: Run tests
  #     run: |
  #       bundle exec fastlane test
        
  # build:
  #   name: Build
  #   runs-on: macos-latest
  #   # needs: test
    
  #   steps:
  #   - name: Checkout
  #     uses: actions/checkout@v4
  #     with:
  #       token: ${{ secrets.GITHUB_TOKEN }}
  #   - name: Setup Ruby
  #     uses: ruby/setup-ruby@v1
  #     with:
  #       ruby-version: '3.2'
  #       bundler-cache: true
        
  #   - name: Setup Xcode
  #     uses: maxim-lobanov/setup-xcode@v1
  #     with:
  #       xcode-version: latest-stable

  #   - name: Install dependencies
  #     run: |
  #       bundle install
        
  #   - name: Build app
  #     run: |
  #       bundle exec fastlane build
        
  #   - name: Upload build artifacts
  #     uses: actions/upload-artifact@v4
  #     with:
  #       name: ios-build
  #       path: build/
 
  release:
    name: Release
    runs-on: macos-latest
    # needs: build
    
    steps:
        - name: Checkout
          uses: actions/checkout@v4
          with:
            ref: ${{ env.RELEASE_BRANCH }}
            token: ${{ secrets.GITHUB_TOKEN }}
            
        - name: Setup Ruby
          uses: ruby/setup-ruby@v1
          with:
            ruby-version: '3.2'
            bundler-cache: true
            
        - name: Install dependencies
          run: |
            bundle install
        
        - name: Get triggering commits
          id: get_commits
          run: |
            # Ensure we have all refs
            git fetch origin
            
            if [ "${{ github.event_name }}" = "push" ]; then
              # For push events, get commits from the push
              TRIGGER_COMMITS=$(echo '${{ toJson(github.event.commits) }}' | jq -r '.[].id' | tr '\n' ',' | sed 's/,$//')
            else
              # For workflow_dispatch, get all commits from origin/main to current branch
              TRIGGER_COMMITS=$(git rev-list origin/main..HEAD --reverse | tr '\n' ',' | sed 's/,$//')
            fi
            bundle exec fastlane filter_merge_commits commits:"$TRIGGER_COMMITS"

        - name: Create pull request
          run: |
            COMMITS=${{ steps.get_commits.outputs.commits }}
            bundle exec fastlane create_pr_from_release_branch_v2 commits:"$COMMITS"

    